<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>p3Dj9aCt04K9</title>
  </head>
  <body>
    <div id="info"></div>
    <a href="googlechromes://dotblogs.com.tw/noncoder/2019/03/27/webview-googlechrome">開啟連結</a>
    <a href="googlechromes://dotblogs.com.tw/noncoder/2019/03/27/webview-googlechrome">開啟連結2</a>
    <script
      src="https://code.jquery.com/jquery-3.6.0.js"
      integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fingerprintjs2/2.1.5/fingerprint2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
      const key = 'abcdefghijklmnop'

      const encrypt = function (message) {
        const encrypt = CryptoJS.AES.encrypt(message, CryptoJS.enc.Utf8.parse(key), {
          mode: CryptoJS.mode.ECB,
          padding: CryptoJS.pad.Pkcs7,
        })
        return encrypt + ''
      }

      const decrypt = function (message) {
        const decrypt = CryptoJS.AES.decrypt(message, CryptoJS.enc.Utf8.parse(key), {
          mode: CryptoJS.mode.ECB,
          padding: CryptoJS.pad.Pkcs7,
        })
        return decrypt.toString(CryptoJS.enc.Utf8)
      }

      let ip_v4 = ''
      let ip_v6 = ''
      let fp_attributes = []
      let fp_id = ''
      let asshole = false
      let first_time = true
      let purge = false
      let action = 'ENTER'
      let customer_id = 'TEST-0001'
      let ps_id = ''
      let customized_data = {}
      const set_customized_data = function (k, v) {
        if (!customized_data.hasOwnProperty(k)) {
          customized_data[k] = v
        }
      }
      let ga_id
      try {
        ga_id = ga.getAll()[0].get('clientId')
      } catch (error) {
        ga_id = ''
      }

      const current_url = window.location.href
      const referrer = document.referrer
      const date = new Date().toISOString().split('T')[0].split('-').join('')
      const token = CryptoJS.MD5('bigdata_' + date + '_bigdata').toString()
      const api = 'http://34.81.73.104:39700/insert_data'

      const uuid = (function uuidv4() {
        return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, function (c) {
          return (c ^ (crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (c / 4)))).toString(16)
        })
      })()

      const tag_list = (function getTag() {
        const tag_element = document.getElementsByClassName('hashtags flexbox flexwrap')
        if (tag_element.length > 0) {
          return tag_element[0].innerText.split('\n')
        } else {
          return ''
        }
      })()

      const window_id = (function makeid(length) {
        let result = ''
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'
        const charactersLength = characters.length
        for (let i = 0; i < length; i++) {
          result += characters.charAt(Math.floor(Math.random() * charactersLength))
        }
        return result
      })(5)

      const get_ip = async () => {
        const data1 = await fetch('https://api.ipify.org?format=jsonp&callback=?')
          .then((res) => res.text())
          .catch((error) => (ip_v4 = `ip_v4的CDN發生問題，錯誤訊息：${error}`))
        ip_v4 = Object.values(JSON.parse(data1.slice(2, data1.length - 2)))[0]
        const data2 = await fetch('https://www.cloudflare.com/cdn-cgi/trace')
          .then((res) => res.text())
          .catch((error) => (ip_v6 = `ip_v6的CDN發生問題，錯誤訊息：${error}`))
        ip_v6 = data2
          .trim()
          .split('\n')
          .reduce(function (obj, pair) {
            pair = pair.split('=')
            return (obj[pair[0]] = pair[1]), obj
          }, {}).ip
        fp_precursor()
      }
      get_ip()

      function fp_precursor() {
        if (window.requestIdleCallback) {
          requestIdleCallback(function () {
            get_fp()
          })
        } else {
          setTimeout(function () {
            get_fp()
          }, 500)
        }
      }

      function get_fp() {
        const options = {
          preprocessor: null,
          audio: {
            timeout: 1000,
            excludeIOS11: true,
          },
          fonts: {
            swfContainerId: 'fingerprintjs2',
            swfPath: 'flash/compiled/FontList.swf',
            userDefinedFonts: [],
            extendedJsFonts: false,
          },
          screen: {
            detectScreenOrientation: true,
          },
          plugins: {
            sortPluginsFor: [/palemoon/i],
            excludeIE: false,
          },
          extraComponents: [],
          excludes: {
            // deviceMemory: true,
            // canvas: true,
            // webgl: true,
            pixelRatio: true,
            doNotTrack: true,
            adBlock: true,
            fontsFlash: true,
            enumerateDevices: true,
          },
          NOT_AVAILABLE: 'not available',
          ERROR: 'error',
          EXCLUDED: 'excluded',
        }

        Fingerprint2.get(options, function (components) {
          const list = components.map(function (component) {
            return component
          })
          const values = components.map(function (component) {
            return component
          })
          fp_id = Fingerprint2.x64hash128(values.join(''), 31)
          $('#info').append(`<h3>${['fp_id']}:${fp_id}</h3>`)
          $('#info').append(`<h3>${['uuid']}:${uuid}</h3>`)
          for (let i = 0; i < list.length; i++) {
            $('#info').append(`<h3>${list[i]['key']}:${list[i]['value']}</h3>`)
          }
        })
      }

      function set_data(fp_id, uuid) {
        const user_data = JSON.parse(localStorage.getItem('dv'))
        let user_id
        if (user_data === null) {
          purge = true
          const encrypt_data = encrypt(`${fp_id},${uuid},${ip_v4},${ip_v6}`)
          const json_data = JSON.stringify({
            create_time: new Date().getTime(),
            last_time: new Date().getTime(),
            user_id: encrypt_data,
            url: current_url,
          })
          localStorage.setItem('dv', json_data)
        } else {
          first_time = false
          try {
            user_id = decrypt(user_data.user_id)
            if (user_id === '') {
              asshole = true
              purge = true
              localStorage.removeItem('dv')
              send_user_data(token, api, fp_attributes)
              return
            }
          } catch (error) {
            if (error) {
              asshole = true
              purge = true
              localStorage.removeItem('dv')
              send_user_data(token, api, fp_attributes)
              return
            }
          }
        }
        if (first_time) {
          send_user_data(token, api, fp_attributes)
        } else {
          let encrypt_data = ''
          let json_data = ''
          old_uuid = user_id.split(',')[1]
          const expiration = (new Date().getTime() - JSON.parse(localStorage.getItem('dv')).create_time) / 1000
          const quickly_visit = (new Date().getTime() - JSON.parse(localStorage.getItem('dv')).last_time) / 1000 < 3
          const the_same_url = current_url === JSON.parse(localStorage.getItem('dv')).url
          encrypt_data = encrypt(`${fp_id},${old_uuid},${ip_v4},${ip_v6}`)
          json_data = JSON.stringify({
            ...user_data,
            user_id: encrypt_data,
            last_time: new Date().getTime(),
            url: current_url,
          })
          localStorage.setItem('dv', json_data)
          if (quickly_visit && the_same_url) {
            return
          }
          if (expiration <= 1800) {
            send_user_data(token, api)
          } else {
            json_data = JSON.stringify({
              ...user_data,
              user_id: user_data.id,
              create_time: new Date().getTime(),
              last_time: new Date().getTime(),
            })
            localStorage.setItem('dv', json_data)
            send_user_data(token, api, fp_attributes)
          }
        }
      }

      async function send_user_data(token, api, fp_attributes = []) {
        const other_attributes = [
          ['fp_id', fp_id],
          ['uuid', uuid],
          ['current_url', current_url],
          ['referrer', referrer],
          ['tags', tag_list],
          ['ip_v4', ip_v4],
          ['ip_v6', ip_v6],
          ['purge', purge],
          ['asshole', asshole],
          ['customized_data', customized_data],
          ['action', action],
          ['window_id', window_id],
          ['ga_id', ga_id],
          ['customer_id', customer_id],
          ['ps_id', ps_id],
        ]
        console.log(other_attributes)
        try {
          const response = await fetch(api, {
            method: 'POST',
            body: JSON.stringify({
              data: Object.fromEntries(new Map(other_attributes.concat(fp_attributes))),
            }),
            headers: new Headers({
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            }),
          })
          const result = await response.json()
          console.log('result', result)
        } catch (error) {
          console.log('error', error.message)
        }
      }
    </script>
  </body>
</html>
